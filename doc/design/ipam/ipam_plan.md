# 地址规划
## 概要
对于给定的一个或多个地址段，提供灵活的策略来规划剩余
的网络位，通过在网络位中编码额外的树状信息，一方面提高
网络聚合，另一方面给ip地址提供更多的信息。

## 动机和目标
- 支持IPv4/IPv6网段，网络位规划
- 展示规划后生成的地址段

## 地址规划
```text

|<--- 21 bit -->|<-----------43 bit ------------->|
---------------------------------------------------
      ISP       |         待规划网络位            |

|<-- 4 bit -->|<-2 bit->|<--  6 bit  -->|<------- 31 bit --------->|
---------------------------------------------------------------------
 业务平台     |业务标识 |   省份标识     |        单位标识          |


|<-- 4 bit -->|<-- 6 bit -->|<--  8 bit  -->|<----- 25 bit  ------->|
---------------------------------------------------------------------
 电视用户     |  省份标识   |  地市标识     |     社区标识          |
``` 
对于除指定前缀之后的剩余的网络位，用户可以灵活的根据
用途，地理位置等，确定
- 用多少位来代表
- 每个取值对应的实际意义
上图中，4位用户用来代表属性（用途）， 有16个取值，0(0000)
代表业务平台，1（0001）代表电视用户，其他的值目前没有设定，
留给以后扩展。

## 展示规划后的地址段
对于不同的规划，特别对于IPv6，可能生成很多网段，但是很
多字段用户并没有指定对应的实际意义只是留做将来扩展，这
中情况下，我们只展示设定了实际值的网络段。


## 详细设计
```text
+----------+
|plan      |
|  prefix  +--+
|  mask_len|  |  +----------------+
|          |  -->+layout          |
+----------+     |  name      	  |
                 |  Plan          |
                 |  autofill      |
                 |  nodes         +--+ 
                 |                |  |   ---------------+
                 +----------------+  --->+planNode      |
                                         |  id 			|
                                         |  Layout      |
                                         |  PId         |
										 |  Name        |
										 |  Sequence    |
										 |  BitWidth    |
										 |  Value       |
										 |  IPv4        |
										 |  Modified    |
                                         +--------------+

```
### Plan
一个指定前缀的网络段，称之为一个Plan，Plan确定了提供的
网络前缀，以及用户希望网络位的长度，对于IPv6网络位目前
只支持64位，IPv4的地址网络位目前不能长于24

### Layout
一个布局，主要确定有哪些段，每个段使用多少位，一个Plan
可以包含一个或多个布局，布局之间产生的网络段不能重合。
Plan中prefix的长度加上所有段的位数，就是用户指定的整个
网络位的长度。

### PlanNode
节点，是布局中的基本数据载体，通过设置父节点（PId）信息，
与其他节点构成树状结构。Sequence标识该节点与其他兄弟节点
之间的顺序关系；Bitwidth标识该节点的位宽N，Value的取值
在[0, 2^N - 1]区间内；IPv4标识该节点的ipv4前缀，如有多个，
用逗号分隔；Modified标识该节点是否被修改过，用于前端调用
update接口的情况。判定该节点是否被修改的依据有：
1.该节点是新增节点，2.该节点自身的值被修改，3.该节点的
子节点被删除。（不被判定该节点被修改的情况包括但不限于：
1.子节点被修改，2.新增子节点。）准确设置Modified值，不仅
有利于程序优化，也是保证逻辑正确的要求。

### 地址段生成
对应于每个Layout，对于IPv6，很多情况下对应的网络段都在2^16
量级，而大部分的网络用户还没有规划使用，所以对于任何一
个Layout，我们只生成Layout的PlanNode中指定了值的网段。
所以如果一个Layout，它有3个PlanNode，每个PlanNode的values
的长度分别是n1,n2,n3，那么它产生的网络段个数就是n1*n2*n3，
所以任何一个段没有指定任何values，那就没有任何网络生成。

## 未来工作
目前Layout之间得冲突检查还没有做，以后需要支持对整个Plan
检查规划的Layout之间的冲突避免用户的不小心导致的冲突。
